package nbcp.web.${group|w}

import io.swagger.annotations.Api
import io.swagger.annotations.ApiOperation
import org.springframework.web.bind.annotation.RestController
import nbcp.base.extend.*
import nbcp.comm.*
import nbcp.db.*
import nbcp.db.sql.*
import nbcp.db.sql.entity.*
import nbcp.db.mysql.*
import nbcp.db.mysql.entity.*
import nbcp.web.*
import javax.servlet.http.HttpServletRequest
import java.time.*

/**
 * Created by CodeGenerator at ${now}
 */
@Api(description = "${title}", tags = arrayOf("${entity}"))
@RestController
@RequestMapping("${url}")
class ${entity}AutoController {

    @ApiOperation("列表")
    @PostMapping("/list")
    fun list(
        ${idKey}: ${idKey|type}, //当列表列新一条后，刷新时使用
${if:name}
        name: String,
${endif}
        @Require skip: Int,
        @Require take: Int,
        request: HttpServletRequest
    ): ListResult<${entity}> {

        dbr.${group|w}.${entity}.query()
            .apply{
                if(${idKey}.HasValue){
                    this.where{it.${idKey} match ${idKey}}
                }
${if:name}
                if(name.HasValue){
                    this.where{ it.name like name }
                }
${endif}
            }
            .limit(skip,take)
            .toListResult()
            .apply{
                return this;
            }
    }

    @ApiOperation("详情")
    @PostMapping("/detail/{id}")
    fun detail(
        @Require ${idKey}: ${idKey|type},
        request: HttpServletRequest
    ): ApiResult<${entity}> {
        dbr.${group|w}.${entity}.queryBy${idKey|W}(${idKey})
            .toEntity()
            .apply{
                if( this == null){
                    return ApiResult<${entity}>("找不到数据")
                }

                return ApiResult.of(this)
            }
    }

    @ApiOperation("更新")
    @PostMapping("/save")
    fun save(
      @JsonModel entity:${entity},
      request: HttpServletRequest
    ): ApiResult<${idKey|type}> {
    //鉴权
    var userId = request.UserId;

    dbr.${group|w}.${entity}.updateWithEntity(entity)
        .withRequestParams()
        .run {
            if (entity.${idKey}.HasValue){
                return@run  this.execUpdate()
            }
            else{
                return@run  this.execInsert();
            }
        }
        .apply{
            if(this == 0){
              return ApiResult("更新失败")
            }

            return ApiResult.of(entity.${idKey})
        }
    }
${if:status}
    @ApiOperation("更新状态，更新一个字段")
    @PostMapping("/set-status")
    fun set(
        @Require ${idKey}: ${idKey|type},
        @Require status: ${status_enum_class},
        request: HttpServletRequest
    ): JsonResult {
        //鉴权
        var userId = request.UserId;


        dbr.${group|w}.${entity}.updateBy${idKey|W}(${idKey})
            .set{it.status to status}
            .set { it.updateAt to LocalDateTime.now() }
            .exec()
            .apply {
                if (this == 0) {
                    return JsonResult("更新失败")
                }

                return JsonResult()
            }
    }
${endif}
    @ApiOperation("删除")
    @PostMapping("/delete/{id}")
    fun delete(
      @Require ${idKey}:${idKey|type},
      request: HttpServletRequest
    ): JsonResult {
    //鉴权
    var userId = request.UserId;

    var entity = dbr.${group|w}.${entity}.queryBy${idKey|W}(${idKey}).toEntity();
    if(entity == null){
        return JsonResult("找不到数据")
    }

    dbr.${group|w}.${entity}.deleteBy${idKey|W}(${idKey})
        .exec()
        .apply{
            if(this == 0){
                return JsonResult("删除失败")
            }
            //实体上配置垃圾箱功能，可物理删除，会自动移到垃圾箱。
            return JsonResult()
        }
    }
}